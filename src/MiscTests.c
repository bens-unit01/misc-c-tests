/*
 * MiscTests.c
 *
 *  Created on: 26 févr. 2021
 *      Author: Utilisateur
 */

#include "MiscTests.h"

int testCalcInt(void){

UINT8 a = 5, b = 3;
   printf("1- (double)(a/b) : %f \r\n", (double)(a/b));
   printf("2- (double)a/b   : %f \r\n", (double)a/b);
   printf("3- (float)a/b    : %f \r\n", (float)a/b);
   printf("4- (float)a/b    : %.3f \r\n", (float)a/b);

   return 1;
}


int testFuelLevelFilter(void){

	float fFuelLevelFilterFast = 67.0;
	int uFuelLevelFilterFast = 67;
	int uFuelLevel = 125;

	puts("Filter test - unit tests ... \r\n");

	for(int i=0; i < 60; i++)
	{
	   uFuelLevelFilterFast = (UINT8) (((uFuelLevelFilterFast * 3) + uFuelLevel) >> 2);
	   fFuelLevelFilterFast = ((((fFuelLevelFilterFast * 5.0) + uFuelLevel) / 6.0)) + 0.001;
	   printf(" %u-\t%u %u %.3f \r\n", i, uFuelLevelFilterFast, (int)fFuelLevelFilterFast, fFuelLevelFilterFast);
	}

	return 1;
}

///* http://www.ccsinfo.com/forum/viewtopic.php?t=24977 */
unsigned short crc16(const unsigned char *buf, unsigned long count)
{
//        unsigned short crc = 0;
        unsigned short crc = 0xFFFF;
        int i;
        int j = 0, k = 0;
        while(count--) {
                printf(" %d 0x%x 0x%x - ", crc, crc, *buf);
                crc = crc ^ *buf++ << 8;

                for (i=0; i<8; i++) {
                        if (crc & 0x8000) {
                                crc = crc << 1 ^ 0x1021;
                                j++;
                        } else {
                                crc = crc << 1;
                                k++;
                        }
                }
        }
        printf("\n ---------------- %d %d \n", j, k);
        return crc;
}


void VimsAsciiToHex(PUINT8 pu8RxData, PUINT8 pu8Size)
{
	UINT32 u32TempData;
	UINT8 u8Index;

	for(u8Index =0; u8Index < *pu8Size; u8Index += 2)
	{
		sscanf((char*)(pu8RxData + u8Index), "%2x", &u32TempData);
		*(pu8RxData + (u8Index/2)) = (UINT8)u32TempData;
	}
	*pu8Size /= 2;
}

int testCrc(void){
// \0010;10;1556036;0521132;5\r\n2476\004
const unsigned char buf1[] = {0x30,  0x3b, 0x31, 0x30, 0x3b, 0x31, 0x35, 0x35,  0x36, 0x30, 0x33, 0x36, 0x3b, 0x30, 0x35, 0x32, 0x31, 0x31, 0x33, 0x32, 0x3b, 0x35, 0x0d, 0x0a};

// 8;aceelectronic.ca;123456789123;;5;1556036;0521132;0;;0.0;;0;0;;0;;;;20;0;0;;;0;0;;0;;0;0;;;;;;;02MAT A", ';' <repeats 16 times>, "U3V46R0H21;M0-G0-DP1-DS1-SS00OFF\r\n
const unsigned char buf2[] = {0x38, 0x3b, 0x61, 0x63, 0x65, 0x65, 0x6c, 0x65 , 0x63, 0x74, 0x72, 0x6f, 0x6e, 0x69, 0x63, 0x2e,
		0x63, 0x61, 0x3b, 0x31, 0x32, 0x33, 0x34, 0x35,  0x36, 0x37, 0x38, 0x39, 0x31, 0x32, 0x33, 0x3b,
		0x3b, 0x35, 0x3b, 0x31, 0x35, 0x35, 0x36, 0x30 , 0x33, 0x36, 0x3b, 0x30, 0x35, 0x32, 0x31, 0x31,
		0x33, 0x32, 0x3b, 0x30, 0x3b, 0x3b, 0x30, 0x2e , 0x30, 0x3b, 0x3b, 0x30, 0x3b, 0x30, 0x3b, 0x3b,
		0x30, 0x3b, 0x3b, 0x3b, 0x3b, 0x32, 0x30, 0x3b,  0x30, 0x3b, 0x30, 0x3b, 0x3b, 0x3b, 0x30, 0x3b,
		0x30, 0x3b, 0x3b, 0x30, 0x3b, 0x3b, 0x30, 0x3b,  0x30, 0x3b, 0x3b, 0x3b, 0x3b, 0x3b, 0x3b, 0x3b,
		0x30, 0x32, 0x4d, 0x41, 0x54, 0x20, 0x41, 0x3b,  0x3b, 0x3b, 0x3b, 0x3b, 0x3b, 0x3b, 0x3b, 0x3b,
		0x3b, 0x3b, 0x3b, 0x3b, 0x3b, 0x3b, 0x3b, 0x55,  0x33, 0x56, 0x34, 0x36, 0x52, 0x30, 0x48, 0x32,
		0x31, 0x3b, 0x4d, 0x30, 0x2d, 0x47, 0x30, 0x2d,  0x44, 0x50, 0x31, 0x2d, 0x44, 0x53, 0x31, 0x2d,
		0x53, 0x53, 0x30, 0x30, 0x4f, 0x46, 0x46, 0x0d, 0x0a};

// \0018;aceelectronic.ca;123456789123;;5;1556036;0521132;0;;0.0;;0;0;;0;;;;20;0;0;;;0;0;;0;;0;0;;;;;;;02MAT A", ';' <repeats 16 times>, "U3V46R0H21;M0-G0-DP1-DS1-SS00OFF\r\n6777\004
const unsigned char buf3[] = {0x01, 0x38, 0x3b, 0x61, 0x63, 0x65, 0x65, 0x6c, 0x65 , 0x63, 0x74, 0x72, 0x6f, 0x6e, 0x69, 0x63, 0x2e,
		0x63, 0x61, 0x3b, 0x31, 0x32, 0x33, 0x34, 0x35,  0x36, 0x37, 0x38, 0x39, 0x31, 0x32, 0x33, 0x3b,
		0x3b, 0x35, 0x3b, 0x31, 0x35, 0x35, 0x36, 0x30 , 0x33, 0x36, 0x3b, 0x30, 0x35, 0x32, 0x31, 0x31,
		0x33, 0x32, 0x3b, 0x30, 0x3b, 0x3b, 0x30, 0x2e , 0x30, 0x3b, 0x3b, 0x30, 0x3b, 0x30, 0x3b, 0x3b,
		0x30, 0x3b, 0x3b, 0x3b, 0x3b, 0x32, 0x30, 0x3b,  0x30, 0x3b, 0x30, 0x3b, 0x3b, 0x3b, 0x30, 0x3b,
		0x30, 0x3b, 0x3b, 0x30, 0x3b, 0x3b, 0x30, 0x3b,  0x30, 0x3b, 0x3b, 0x3b, 0x3b, 0x3b, 0x3b, 0x3b,
		0x30, 0x32, 0x4d, 0x41, 0x54, 0x20, 0x41, 0x3b,  0x3b, 0x3b, 0x3b, 0x3b, 0x3b, 0x3b, 0x3b, 0x3b,
		0x3b, 0x3b, 0x3b, 0x3b, 0x3b, 0x3b, 0x3b, 0x55,  0x33, 0x56, 0x34, 0x36, 0x52, 0x30, 0x48, 0x32,
		0x31, 0x3b, 0x4d, 0x30, 0x2d, 0x47, 0x30, 0x2d,  0x44, 0x50, 0x31, 0x2d, 0x44, 0x53, 0x31, 0x2d,
		0x53, 0x53, 0x30, 0x30, 0x4f, 0x46, 0x46, 0x0d, 0x0a, 0x36, 0x37, 0x37, 0x37, 0x04};

unsigned char buf4[4] = {0};

  int res1 = crc16(buf1, sizeof(buf1));
  printf(" buf size:  %d res : %d 0x%x \n", sizeof(buf1), res1, res1);

  printf("\n\n");

  int res2 = crc16(buf2, sizeof(buf2));
  printf(" buf size:  %d res : %d 0x%x \n", sizeof(buf2), res2, res2);

  int res3 = crc16(buf3 +1, sizeof(buf3) -6);
   printf(" buf size:  %d res : %d 0x%x \n", sizeof(buf3), res3, res3);

  const char st1[] = {'6', '7', '7', '7', '\0'};
  printf(" 1-  %s \n", st1);
 // VimsAsciiToHex(st, &size);
  printf(" 2-  %d  \n", atoi(st1));
  int number1 = (int)strtol(st1, NULL, 16);
  printf(" 3-  %d  \n", number1);

  const char st2[] = {',', '!', '7', '-', '\0'};
  int number2 = (int)strtol(st2, NULL, 16);
  printf(" 4-  %d  \n", number2);


  memcpy(buf4, buf3 + (sizeof(buf3) -5), 4);
  int number3 = (int)strtol((const char *)buf4, NULL, 16);
  printf(" 5-  0x%x  \n", number3);

  const char src[50] = "http://www.tutorialspoint.com";
  char dest1[50];
  char dest2[5] = {0};
  strcpy(dest1,"Heloooo!!");
  printf("Before memcpy dest = %s\n", dest1);

  memcpy(dest1, (src + 5), strlen(src)+1);
  memcpy(dest2, (buf3 + (sizeof(buf3) -5)), 4);

  printf("After memcpy dest1 = %s\n", dest1);
  printf("After memcpy dest2 = %s\n", dest2);

  return 0;
}








